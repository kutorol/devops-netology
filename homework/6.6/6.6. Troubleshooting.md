# Домашнее задание к занятию "6.6. Troubleshooting"

## Задача 1

Перед выполнением задания ознакомьтесь с документацией по [администрированию MongoDB](https://docs.mongodb.com/manual/administration/).

Пользователь (разработчик) написал в канал поддержки, что у него уже 3 минуты происходит CRUD операция в MongoDB и её 
нужно прервать. 

Вы как инженер поддержки решили произвести данную операцию:
- напишите список операций, которые вы будете производить для остановки запроса пользователя
> Поиском находим все операции, которые длятся дольше 50 секунд
> 
> db.currentOp().inprog.forEach(function(op) { if(op.secs_running > 50) printjson(op); })
>
> Далее ищем в списке ID нужной нам операции
> 
> "opid": 123456789,
> 
> После вызываем ее остановку командой db.killOp(123456789)
>
> Можно так же изначально в MongoDB установить максимальное время выполнение операции, чтобы база данных сама прерывала операции, время которых больше установленного
> 
> maxTimeMS()

- предложите вариант решения проблемы с долгими (зависающими) запросами в MongoDB
> - Как писал выше, можно воспользоваться методом maxTimeMS()
> - Если на бд идет много подключений, то можно использовать метод maxIncomingConnections, чтобы установить новое ограничение
> - Если не хватает места на диске, то собственно увеличить место на диске
> - Возможно следует исправить запросы, т.к. они могут быть не эффективны, что и приводит к длительному выполнению (возможно также стоит изменить/добавить индексы)
> - Дополнительно нужно включить мониторинг, чтобы отслеживать нагрузку на сервер, утилизацию диска, время выполнения. Команда db.enableFreeMonitoring()

## Задача 2

Перед выполнением задания познакомьтесь с документацией по [Redis latency troobleshooting](https://redis.io/topics/latency).

Вы запустили инстанс Redis для использования совместно с сервисом, который использует механизм TTL. 
Причем отношение количества записанных key-value значений к количеству истёкших значений есть величина постоянная и
увеличивается пропорционально количеству реплик сервиса. 

При масштабировании сервиса до N реплик вы увидели, что:
- сначала рост отношения записанных значений к истекшим
- Redis блокирует операции записи

Как вы думаете, в чем может быть проблема?
> - Отвалилась одна из нод кластера
> - Параметр maxmemory - выделенная RAM закончилась
> - Банально закончилось место в хранилище
> - Обязательно почитать логи, чтобы лучше понять проблему 

## Задача 3

Перед выполнением задания познакомьтесь с документацией по [Common Mysql errors](https://dev.mysql.com/doc/refman/8.0/en/common-errors.html).

Вы подняли базу данных MySQL для использования в гис-системе. При росте количества записей, в таблицах базы,
пользователи начали жаловаться на ошибки вида:
```python
InterfaceError: (InterfaceError) 2013: Lost connection to MySQL server during query u'SELECT..... '
```

Как вы думаете, почему это начало происходить и как локализовать проблему?

Какие пути решения данной проблемы вы можете предложить?

> - Проверить, жив ли сервис
> - Сетевые проблемы. Недоступность СУБД.
> - Анализ логов mysql. Возможно произошла не хватка ресурсов хоста. Значит нужно или освобождать, или наращивать ресурсы. 
> - Увеличить таймаут на выполнение запроса, т.к. может быть неоптимизированный запрос, который можно найти по логам
> - - Командой `SHOW GLOBAL STATUS LIKE 'Aborted_connects'` можно посмотреть значение отклоненных запросов, и если оно увеличивается с возникновением ошибки, то увеличение таймаута должно помочь
> - Может быть не хватает количества соединений, значит нужно увеличить их
> - Возможно проблема связана с большим значением BLOB, превышающий параметр `max_allowed_packet`
> - - Необходимо будет увеличить значение параметра `max_allowed_packet` как на сервере, так и на клиент

## Задача 4

Перед выполнением задания ознакомтесь со статьей [Common PostgreSQL errors](https://www.percona.com/blog/2020/06/05/10-common-postgresql-errors/) из блога Percona.

Вы решили перевести гис-систему из задачи 3 на PostgreSQL, так как прочитали в документации, что эта СУБД работает с 
большим объемом данных лучше, чем MySQL.

После запуска пользователи начали жаловаться, что СУБД время от времени становится недоступной. В dmesg вы видите, что:

`postmaster invoked oom-killer`

Как вы думаете, что происходит?

Как бы вы решили данную проблему?
> На сервере закончилась память, механизм самосохранения убил процесс postgres чтобы ОС продолжила функционировать.
> 
> Для решения данной ситуации, можно изменить значение `vm.overcommit_memory` равным 2 (работать без overcommit), что снизит вероятность того, что OOM-Killer завершит процесс PostgreSQL. Но самым лучшим методом решения будет конечно же увеличение оперативной памяти.
